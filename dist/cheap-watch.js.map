{"version":3,"file":"cheap-watch.js","sources":["../node_modules/cheap-watch/dist/CheapWatch.es.js"],"sourcesContent":["import * as EventEmitter from 'events';\nimport { readdir, stat, watch } from 'fs';\nimport { promisify } from 'util';\n\nconst readdir$1 = promisify(readdir);\nconst stat$1 = promisify(stat);\nclass CheapWatch extends EventEmitter {\n    constructor(data) {\n        super();\n        this.watch = true;\n        this.debounce = 10;\n        this.paths = new Map();\n        this._watchers = new Map();\n        this._timeouts = new Map();\n        this._queue = [];\n        this._status = 0;\n        Object.assign(this, data);\n        if (typeof this.dir !== 'string') {\n            throw new TypeError('dir must be a string');\n        }\n        if (this.filter && typeof this.filter !== 'function') {\n            throw new TypeError('filter must be a function');\n        }\n        if (typeof this.watch !== 'boolean') {\n            throw new TypeError('watch must be a boolean');\n        }\n        if (typeof this.debounce !== 'number') {\n            throw new TypeError('debounce must be a number');\n        }\n    }\n    async init() {\n        if (this._status !== 0) {\n            throw new Error('cannot call init() twice');\n        }\n        this._status = 1;\n        await this._recurse(this.dir);\n        this._status = 2;\n    }\n    close() {\n        if (this._status === 0 || this._status === 1) {\n            throw new Error('cannot call close() before init() finishes');\n        }\n        if (this._status === 4) {\n            throw new Error('cannot call close() twice');\n        }\n        this._status = 4;\n        for (const watcher of this._watchers.values()) {\n            watcher.close();\n        }\n    }\n    async _recurse(full) {\n        const path = full.slice(this.dir.length + 1);\n        const stats = await stat$1(full);\n        if (path) {\n            if (this.filter && !(await this.filter({ path, stats }))) {\n                return;\n            }\n            this.paths.set(path, stats);\n        }\n        if (stats.isDirectory()) {\n            if (this.watch) {\n                this._watchers.set(path, watch(full, this._handle.bind(this, full)).on('error', () => { }));\n            }\n            await Promise.all((await readdir$1(full)).map(sub => this._recurse(full + '/' + sub)));\n        }\n    }\n    _handle(dir, event, file) {\n        const full = dir + '/' + file;\n        if (this._timeouts.has(full)) {\n            clearTimeout(this._timeouts.get(full));\n        }\n        this._timeouts.set(full, setTimeout(() => {\n            this._timeouts.delete(full);\n            this._enqueue(full);\n        }, this.debounce));\n    }\n    async _enqueue(full) {\n        this._queue.push(full);\n        if (this._status !== 2) {\n            return;\n        }\n        this._status = 3;\n        while (this._queue.length) {\n            const full = this._queue.shift();\n            const path = full.slice(this.dir.length + 1);\n            const stats = await stat$1(full).catch(() => { });\n            if (stats) {\n                if (this.filter && !(await this.filter({ path, stats }))) {\n                    continue;\n                }\n                const isNew = !this.paths.has(path);\n                this.paths.set(path, stats);\n                if (path) {\n                    this.emit('+', { path, stats, isNew });\n                }\n                if (stats.isDirectory() && !this._watchers.has(path)) {\n                    await this._recurse(full);\n                    for (const [newPath, stats] of this.paths.entries()) {\n                        if (newPath.startsWith(path + '/')) {\n                            this.emit('+', { path: newPath, stats, isNew: true });\n                        }\n                    }\n                }\n            }\n            else if (this.paths.has(path)) {\n                const stats = this.paths.get(path);\n                this.paths.delete(path);\n                this.emit('-', { path, stats });\n                if (this._watchers.has(path)) {\n                    for (const old of this._watchers.keys()) {\n                        if (old === path || old.startsWith(path + '/')) {\n                            this._watchers.get(old).close();\n                            this._watchers.delete(old);\n                        }\n                    }\n                    for (const old of this.paths.keys()) {\n                        if (old.startsWith(path + '/')) {\n                            const stats = this.paths.get(old);\n                            this.paths.delete(old);\n                            this.emit('-', { path: old, stats });\n                        }\n                    }\n                }\n            }\n        }\n        this._status = 2;\n    }\n}\n\nexport default CheapWatch;\n//# sourceMappingURL=CheapWatch.es.js.map\n"],"names":["promisify","readdir","stat","watch"],"mappings":"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"}