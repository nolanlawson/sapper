{"version":3,"file":"build.js","sources":["../src/api/build.ts"],"sourcesContent":["import * as fs from 'fs';\nimport * as path from 'path';\nimport mkdirp from 'mkdirp';\nimport rimraf from 'rimraf';\nimport minify_html from './utils/minify_html';\nimport { create_compilers, create_main_manifests, create_manifest_data, create_serviceworker_manifest } from '../core';\nimport { copy_shimport } from './utils/copy_shimport';\nimport read_template from '../core/read_template';\nimport { CompileResult } from '../core/create_compilers/interfaces';\nimport { noop } from './utils/noop';\nimport validate_bundler from './utils/validate_bundler';\n\ntype Opts = {\n\tcwd?: string;\n\tsrc?: string;\n\troutes?: string;\n\tdest?: string;\n\toutput?: string;\n\tstatic?: string;\n\tlegacy?: boolean;\n\tbundler?: 'rollup' | 'webpack';\n\toncompile?: ({ type, result }: { type: string, result: CompileResult }) => void;\n};\n\nexport async function build({\n\tcwd,\n\tsrc = 'src',\n\troutes = 'src/routes',\n\toutput = '__sapper__',\n\tstatic: static_files = 'static',\n\tdest = '__sapper__/build',\n\n\tbundler,\n\tlegacy = false,\n\toncompile = noop\n}: Opts = {}) {\n\tbundler = validate_bundler(bundler);\n\n\tcwd = path.resolve(cwd);\n\tsrc = path.resolve(cwd, src);\n\tdest = path.resolve(cwd, dest);\n\troutes = path.resolve(cwd, routes);\n\toutput = path.resolve(cwd, output);\n\tstatic_files = path.resolve(cwd, static_files);\n\n\tif (legacy && bundler === 'webpack') {\n\t\tthrow new Error(`Legacy builds are not supported for projects using webpack`);\n\t}\n\n\trimraf.sync(path.join(dest, '**/*'));\n\tmkdirp.sync(`${dest}/client`);\n\tcopy_shimport(dest);\n\n\t// minify src/template.html\n\t// TODO compile this to a function? could be quicker than str.replace(...).replace(...).replace(...)\n\tconst template = read_template(src);\n\n\t// remove this in a future version\n\tif (template.indexOf('%sapper.base%') === -1) {\n\t\tconst error = new Error(`As of Sapper v0.10, your template.html file must include %sapper.base% in the <head>`);\n\t\terror.code = `missing-sapper-base`;\n\t\tthrow error;\n\t}\n\n\tfs.writeFileSync(`${dest}/template.html`, minify_html(template));\n\n\tconst manifest_data = create_manifest_data(routes);\n\n\t// create src/manifest/client.js and src/manifest/server.js\n\tcreate_main_manifests({\n\t\tbundler,\n\t\tmanifest_data,\n\t\tcwd,\n\t\tsrc,\n\t\tdest,\n\t\troutes,\n\t\toutput,\n\t\tdev: false\n\t});\n\n\tconst { client, server, serviceworker } = await create_compilers(bundler, cwd, src, dest, true);\n\n\tconst client_result = await client.compile();\n\toncompile({\n\t\ttype: 'client',\n\t\tresult: client_result\n\t});\n\n\tconst build_info = client_result.to_json(manifest_data, { src, routes, dest });\n\n\tif (legacy) {\n\t\tprocess.env.SAPPER_LEGACY_BUILD = 'true';\n\t\tconst { client } = await create_compilers(bundler, cwd, src, dest, true);\n\n\t\tconst client_result = await client.compile();\n\n\t\toncompile({\n\t\t\ttype: 'client (legacy)',\n\t\t\tresult: client_result\n\t\t});\n\n\t\tclient_result.to_json(manifest_data, { src, routes, dest });\n\t\tbuild_info.legacy_assets = client_result.assets;\n\t\tdelete process.env.SAPPER_LEGACY_BUILD;\n\t}\n\n\tfs.writeFileSync(path.join(dest, 'build.json'), JSON.stringify(build_info));\n\n\tconst server_stats = await server.compile();\n\toncompile({\n\t\ttype: 'server',\n\t\tresult: server_stats\n\t});\n\n\tlet serviceworker_stats;\n\n\tif (serviceworker) {\n\n\t\tconst client_files = client_result.chunks\n\t\t\t.filter(chunk => !chunk.file.endsWith('.map')) // SW does not need to cache sourcemap files\n\t\t\t.map(chunk => `client/${chunk.file}`);\n\n\t\tcreate_serviceworker_manifest({\n\t\t\tmanifest_data,\n\t\t\toutput,\n\t\t\tclient_files,\n\t\t\tstatic_files\n\t\t});\n\n\t\tserviceworker_stats = await serviceworker.compile();\n\n\t\toncompile({\n\t\t\ttype: 'serviceworker',\n\t\t\tresult: serviceworker_stats\n\t\t});\n\t}\n}"],"names":["validate_bundler","path.resolve","rimraf","path.join","mkdirp","copy_shimport","read_template","fs.writeFileSync","minify_html","create_manifest_data","create_main_manifests","create_compilers","create_serviceworker_manifest"],"mappings":"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"}