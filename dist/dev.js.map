{"version":3,"file":"dev.js","sources":["../src/api/dev.ts"],"sourcesContent":["import * as path from 'path';\nimport * as fs from 'fs';\nimport * as http from 'http';\nimport * as child_process from 'child_process';\nimport * as ports from 'port-authority';\nimport mkdirp from 'mkdirp';\nimport rimraf from 'rimraf';\nimport { EventEmitter } from 'events';\nimport { create_manifest_data, create_main_manifests, create_compilers, create_serviceworker_manifest } from '../core';\nimport { Compiler, Compilers } from '../core/create_compilers';\nimport { CompileResult } from '../core/create_compilers/interfaces';\nimport Deferred from './utils/Deferred';\nimport validate_bundler from './utils/validate_bundler';\nimport { copy_shimport } from './utils/copy_shimport';\nimport { ManifestData, FatalEvent, ErrorEvent, ReadyEvent, InvalidEvent } from '../interfaces';\nimport read_template from '../core/read_template';\nimport { noop } from './utils/noop';\n\ntype Opts = {\n\tcwd?: string,\n\tsrc?: string,\n\tdest?: string,\n\troutes?: string,\n\toutput?: string,\n\tstatic?: string,\n\t'dev-port'?: number,\n\tlive?: boolean,\n\thot?: boolean,\n\t'devtools-port'?: number,\n\tbundler?: 'rollup' | 'webpack',\n\tport?: number\n};\n\nexport function dev(opts: Opts) {\n\treturn new Watcher(opts);\n}\n\nclass Watcher extends EventEmitter {\n\tbundler: 'rollup' | 'webpack';\n\tdirs: {\n\t\tcwd: string;\n\t\tsrc: string;\n\t\tdest: string;\n\t\troutes: string;\n\t\toutput: string;\n\t\tstatic: string;\n\t}\n\tport: number;\n\tclosed: boolean;\n\n\tdev_port: number;\n\tlive: boolean;\n\thot: boolean;\n\n\tdevtools_port: number;\n\n\tdev_server: DevServer;\n\tproc: child_process.ChildProcess;\n\tfilewatchers: Array<{ close: () => void }>;\n\tdeferred: Deferred;\n\n\tcrashed: boolean;\n\trestarting: boolean;\n\tcurrent_build: {\n\t\tchanged: Set<string>;\n\t\trebuilding: Set<string>;\n\t\tunique_warnings: Set<string>;\n\t\tunique_errors: Set<string>;\n\t}\n\n\tconstructor({\n\t\tcwd = '.',\n\t\tsrc = 'src',\n\t\troutes = 'src/routes',\n\t\toutput = '__sapper__',\n\t\tstatic: static_files = 'static',\n\t\tdest = '__sapper__/dev',\n\t\t'dev-port': dev_port,\n\t\tlive,\n\t\thot,\n\t\t'devtools-port': devtools_port,\n\t\tbundler,\n\t\tport = +process.env.PORT\n\t}: Opts) {\n\t\tsuper();\n\n\t\tcwd = path.resolve(cwd);\n\n\t\tthis.bundler = validate_bundler(bundler);\n\t\tthis.dirs = {\n\t\t\tcwd,\n\t\t\tsrc: path.resolve(cwd, src),\n\t\t\tdest: path.resolve(cwd, dest),\n\t\t\troutes: path.resolve(cwd, routes),\n\t\t\toutput: path.resolve(cwd, output),\n\t\t\tstatic: path.resolve(cwd, static_files)\n\t\t};\n\n\t\tthis.port = port;\n\t\tthis.closed = false;\n\n\t\tthis.dev_port = dev_port;\n\t\tthis.live = live;\n\t\tthis.hot = hot;\n\n\t\tthis.devtools_port = devtools_port;\n\n\t\tthis.filewatchers = [];\n\n\t\tthis.current_build = {\n\t\t\tchanged: new Set(),\n\t\t\trebuilding: new Set(),\n\t\t\tunique_errors: new Set(),\n\t\t\tunique_warnings: new Set()\n\t\t};\n\n\t\t// remove this in a future version\n\t\tconst template = read_template(src);\n\t\tif (template.indexOf('%sapper.base%') === -1) {\n\t\t\tconst error = new Error(`As of Sapper v0.10, your template.html file must include %sapper.base% in the <head>`);\n\t\t\terror.code = `missing-sapper-base`;\n\t\t\tthrow error;\n\t\t}\n\n\t\tprocess.env.NODE_ENV = 'development';\n\n\t\tprocess.on('exit', () => {\n\t\t\tthis.close();\n\t\t});\n\n\t\tthis.init();\n\t}\n\n\tasync init() {\n\t\tif (this.port) {\n\t\t\tif (!await ports.check(this.port)) {\n\t\t\t\tthis.emit('fatal', <FatalEvent>{\n\t\t\t\t\tmessage: `Port ${this.port} is unavailable`\n\t\t\t\t});\n\t\t\t\treturn;\n\t\t\t}\n\t\t} else {\n\t\t\tthis.port = await ports.find(3000);\n\t\t}\n\n\t\tconst { cwd, src, dest, routes, output, static: static_files } = this.dirs;\n\t\trimraf.sync(dest);\n\t\tmkdirp.sync(`${dest}/client`);\n\t\tif (this.bundler === 'rollup') copy_shimport(dest);\n\n\t\tif (!this.dev_port) this.dev_port = await ports.find(10000);\n\n\t\t// Chrome looks for debugging targets on ports 9222 and 9229 by default\n\t\tif (!this.devtools_port) this.devtools_port = await ports.find(9222);\n\n\t\tlet manifest_data: ManifestData;\n\n\t\ttry {\n\t\t\tmanifest_data = create_manifest_data(routes);\n\t\t\tcreate_main_manifests({\n\t\t\t\tbundler: this.bundler,\n\t\t\t\tmanifest_data,\n\t\t\t\tdev: true,\n\t\t\t\tdev_port: this.dev_port,\n\t\t\t\tcwd, src, dest, routes, output\n\t\t\t});\n\t\t} catch (err) {\n\t\t\tthis.emit('fatal', <FatalEvent>{\n\t\t\t\tmessage: err.message\n\t\t\t});\n\t\t\treturn;\n\t\t}\n\n\t\tthis.dev_server = new DevServer(this.dev_port);\n\n\t\tthis.filewatchers.push(\n\t\t\twatch_dir(\n\t\t\t\troutes,\n\t\t\t\t({ path: file, stats }) => {\n\t\t\t\t\tif (stats.isDirectory()) {\n\t\t\t\t\t\treturn path.basename(file)[0] !== '_';\n\t\t\t\t\t}\n\t\t\t\t\treturn true;\n\t\t\t\t},\n\t\t\t\t() => {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst new_manifest_data = create_manifest_data(routes);\n\t\t\t\t\t\tcreate_main_manifests({\n\t\t\t\t\t\t\tbundler: this.bundler,\n\t\t\t\t\t\t\tmanifest_data, // TODO is this right? not new_manifest_data?\n\t\t\t\t\t\t\tdev: true,\n\t\t\t\t\t\t\tdev_port: this.dev_port,\n\t\t\t\t\t\t\tcwd, src, dest, routes, output\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\tmanifest_data = new_manifest_data;\n\t\t\t\t\t} catch (err) {\n\t\t\t\t\t\tthis.emit('error', <ErrorEvent>{\n\t\t\t\t\t\t\tmessage: err.message\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t),\n\n\t\t\tfs.watch(`${src}/template.html`, () => {\n\t\t\t\tthis.dev_server.send({\n\t\t\t\t\taction: 'reload'\n\t\t\t\t});\n\t\t\t})\n\t\t);\n\n\t\tlet deferred = new Deferred();\n\n\t\t// TODO watch the configs themselves?\n\t\tconst compilers: Compilers = await create_compilers(this.bundler, cwd, src, dest, false);\n\n\t\tconst emitFatal = () => {\n\t\t\tthis.emit('fatal', <FatalEvent>{\n\t\t\t\tmessage: `Server crashed`\n\t\t\t});\n\n\t\t\tthis.crashed = true;\n\t\t\tthis.proc = null;\n\t\t};\n\n\t\tthis.watch(compilers.server, {\n\t\t\tname: 'server',\n\n\t\t\tinvalid: filename => {\n\t\t\t\tthis.restart(filename, 'server');\n\t\t\t},\n\n\t\t\thandle_result: (result: CompileResult) => {\n\t\t\t\tdeferred.promise.then(() => {\n\t\t\t\t\tconst restart = () => {\n\t\t\t\t\t\tthis.crashed = false;\n\n\t\t\t\t\t\tports.wait(this.port)\n\t\t\t\t\t\t\t.then((() => {\n\t\t\t\t\t\t\t\tthis.emit('ready', <ReadyEvent>{\n\t\t\t\t\t\t\t\t\tport: this.port,\n\t\t\t\t\t\t\t\t\tprocess: this.proc\n\t\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\t\tif (this.hot && this.bundler === 'webpack') {\n\t\t\t\t\t\t\t\t\tthis.dev_server.send({\n\t\t\t\t\t\t\t\t\t\tstatus: 'completed'\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\tthis.dev_server.send({\n\t\t\t\t\t\t\t\t\t\taction: 'reload'\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}))\n\t\t\t\t\t\t\t.catch(err => {\n\t\t\t\t\t\t\t\tif (this.crashed) return;\n\n\t\t\t\t\t\t\t\tthis.emit('fatal', <FatalEvent>{\n\t\t\t\t\t\t\t\t\tmessage: `Server is not listening on port ${this.port}`\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t});\n\t\t\t\t\t};\n\n\t\t\t\t\tif (this.proc) {\n\t\t\t\t\t\tthis.proc.removeListener('exit', emitFatal);\n\t\t\t\t\t\tthis.proc.kill();\n\t\t\t\t\t\tthis.proc.on('exit', restart);\n\t\t\t\t\t} else {\n\t\t\t\t\t\trestart();\n\t\t\t\t\t}\n\n\t\t\t\t\t// we need to give the child process its own DevTools port,\n\t\t\t\t\t// otherwise Node will try to use the parent's (and fail)\n\t\t\t\t\tconst debugArgRegex = /--inspect(?:-brk|-port)?|--debug-port/;\n\t\t\t\t\tconst execArgv = process.execArgv.slice();\n\t\t\t\t\tif (execArgv.some((arg: string) => !!arg.match(debugArgRegex))) {\n\t\t\t\t\t\texecArgv.push(`--inspect-port=${this.devtools_port}`);\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.proc = child_process.fork(`${dest}/server/server.js`, [], {\n\t\t\t\t\t\tcwd: process.cwd(),\n\t\t\t\t\t\tenv: Object.assign({\n\t\t\t\t\t\t\tPORT: this.port\n\t\t\t\t\t\t}, process.env),\n\t\t\t\t\t\tstdio: ['ipc'],\n\t\t\t\t\t\texecArgv\n\t\t\t\t\t});\n\n\t\t\t\t\tthis.proc.stdout.on('data', chunk => {\n\t\t\t\t\t\tthis.emit('stdout', chunk);\n\t\t\t\t\t});\n\n\t\t\t\t\tthis.proc.stderr.on('data', chunk => {\n\t\t\t\t\t\tthis.emit('stderr', chunk);\n\t\t\t\t\t});\n\n\t\t\t\t\tthis.proc.on('message', message => {\n\t\t\t\t\t\tif (message.__sapper__ && message.event === 'basepath') {\n\t\t\t\t\t\t\tthis.emit('basepath', {\n\t\t\t\t\t\t\t\tbasepath: message.basepath\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\n\t\t\t\t\tthis.proc.on('exit', emitFatal);\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\n\t\tthis.watch(compilers.client, {\n\t\t\tname: 'client',\n\n\t\t\tinvalid: filename => {\n\t\t\t\tthis.restart(filename, 'client');\n\t\t\t\tdeferred = new Deferred();\n\n\t\t\t\t// TODO we should delete old assets. due to a webpack bug\n\t\t\t\t// i don't even begin to comprehend, this is apparently\n\t\t\t\t// quite difficult\n\t\t\t},\n\n\t\t\thandle_result: (result: CompileResult) => {\n\t\t\t\tfs.writeFileSync(\n\t\t\t\t\tpath.join(dest, 'build.json'),\n\n\t\t\t\t\t// TODO should be more explicit that to_json has effects\n\t\t\t\t\tJSON.stringify(result.to_json(manifest_data, this.dirs), null, '  ')\n\t\t\t\t);\n\n\t\t\t\tconst client_files = result.chunks.map(chunk => `client/${chunk.file}`);\n\n\t\t\t\tcreate_serviceworker_manifest({\n\t\t\t\t\tmanifest_data,\n\t\t\t\t\toutput,\n\t\t\t\t\tclient_files,\n\t\t\t\t\tstatic_files\n\t\t\t\t});\n\n\t\t\t\tdeferred.fulfil();\n\n\t\t\t\t// we need to wait a beat before watching the service\n\t\t\t\t// worker, because of some webpack nonsense\n\t\t\t\tsetTimeout(watch_serviceworker, 100);\n\t\t\t}\n\t\t});\n\n\t\tlet watch_serviceworker = compilers.serviceworker\n\t\t\t? () => {\n\t\t\t\twatch_serviceworker = noop;\n\n\t\t\t\tthis.watch(compilers.serviceworker, {\n\t\t\t\t\tname: 'service worker'\n\t\t\t\t});\n\t\t\t}\n\t\t\t: noop;\n\t}\n\n\tclose() {\n\t\tif (this.closed) return;\n\t\tthis.closed = true;\n\n\t\tif (this.dev_server) this.dev_server.close();\n\n\t\tif (this.proc) this.proc.kill();\n\t\tthis.filewatchers.forEach(watcher => {\n\t\t\twatcher.close();\n\t\t});\n\t}\n\n\trestart(filename: string, type: string) {\n\t\tif (this.restarting) {\n\t\t\tthis.current_build.changed.add(filename);\n\t\t\tthis.current_build.rebuilding.add(type);\n\t\t} else {\n\t\t\tthis.restarting = true;\n\n\t\t\tthis.current_build = {\n\t\t\t\tchanged: new Set([filename]),\n\t\t\t\trebuilding: new Set([type]),\n\t\t\t\tunique_warnings: new Set(),\n\t\t\t\tunique_errors: new Set()\n\t\t\t};\n\n\t\t\tprocess.nextTick(() => {\n\t\t\t\tthis.emit('invalid', <InvalidEvent>{\n\t\t\t\t\tchanged: Array.from(this.current_build.changed),\n\t\t\t\t\tinvalid: {\n\t\t\t\t\t\tserver: this.current_build.rebuilding.has('server'),\n\t\t\t\t\t\tclient: this.current_build.rebuilding.has('client'),\n\t\t\t\t\t\tserviceworker: this.current_build.rebuilding.has('serviceworker'),\n\t\t\t\t\t}\n\t\t\t\t});\n\n\t\t\t\tthis.restarting = false;\n\t\t\t});\n\t\t}\n\t}\n\n\twatch(compiler: Compiler, { name, invalid = noop, handle_result = noop }: {\n\t\tname: string,\n\t\tinvalid?: (filename: string) => void;\n\t\thandle_result?: (result: CompileResult) => void;\n\t}) {\n\t\tcompiler.oninvalid(invalid);\n\n\t\tcompiler.watch((err?: Error, result?: CompileResult) => {\n\t\t\tif (err) {\n\t\t\t\tthis.emit('error', <ErrorEvent>{\n\t\t\t\t\ttype: name,\n\t\t\t\t\tmessage: err.message\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tthis.emit('build', {\n\t\t\t\t\ttype: name,\n\n\t\t\t\t\tduration: result.duration,\n\t\t\t\t\terrors: result.errors,\n\t\t\t\t\twarnings: result.warnings\n\t\t\t\t});\n\n\t\t\t\thandle_result(result);\n\t\t\t}\n\t\t});\n\t}\n}\n\nconst INTERVAL = 10000;\n\nclass DevServer {\n\tclients: Set<http.ServerResponse>;\n\tinterval: NodeJS.Timer;\n\t_: http.Server;\n\n\tconstructor(port: number, interval = 10000) {\n\t\tthis.clients = new Set();\n\n\t\tthis._ = http.createServer((req, res) => {\n\t\t\tif (req.url !== '/__sapper__') return;\n\n\t\t\treq.socket.setKeepAlive(true);\n\t\t\tres.writeHead(200, {\n\t\t\t\t'Access-Control-Allow-Origin': '*',\n\t\t\t\t'Access-Control-Allow-Headers': 'Cache-Control',\n\t\t\t\t'Content-Type': 'text/event-stream;charset=utf-8',\n\t\t\t\t'Cache-Control': 'no-cache, no-transform',\n\t\t\t\t'Connection': 'keep-alive',\n\t\t\t\t// While behind nginx, event stream should not be buffered:\n\t\t\t\t// http://nginx.org/docs/http/ngx_http_proxy_module.html#proxy_buffering\n\t\t\t\t'X-Accel-Buffering': 'no'\n\t\t\t});\n\n\t\t\tres.write('\\n');\n\n\t\t\tthis.clients.add(res);\n\t\t\treq.on('close', () => {\n\t\t\t\tthis.clients.delete(res);\n\t\t\t});\n\t\t});\n\n\t\tthis._.listen(port);\n\n\t\tthis.interval = setInterval(() => {\n\t\t\tthis.send(null);\n\t\t}, INTERVAL);\n\t}\n\n\tclose() {\n\t\tthis._.close();\n\t\tclearInterval(this.interval);\n\t}\n\n\tsend(data: any) {\n\t\tthis.clients.forEach(client => {\n\t\t\tclient.write(`data: ${JSON.stringify(data)}\\n\\n`);\n\t\t});\n\t}\n}\n\nfunction watch_dir(\n\tdir: string,\n\tfilter: ({ path, stats }: { path: string, stats: fs.Stats }) => boolean,\n\tcallback: () => void\n) {\n\tlet watch: any;\n\tlet closed = false;\n\n\timport('cheap-watch').then(CheapWatch => {\n\t\tif (closed) return;\n\n\t\twatch = new CheapWatch({ dir, filter, debounce: 50 });\n\n\t\twatch.on('+', ({ isNew }: { isNew: boolean }) => {\n\t\t\tif (isNew) callback();\n\t\t});\n\n\t\twatch.on('-', callback);\n\n\t\twatch.init();\n\t});\n\n\treturn {\n\t\tclose: () => {\n\t\t\tif (watch) watch.close();\n\t\t\tclosed = true;\n\t\t}\n\t};\n}"],"names":["tslib_1.__extends","path.resolve","validate_bundler","read_template","ports.check","ports.find","rimraf","mkdirp","copy_shimport","create_manifest_data","create_main_manifests","path.basename","fs.watch","Deferred","create_compilers","ports.wait","child_process.fork","fs.writeFileSync","path.join","create_serviceworker_manifest","noop","EventEmitter","http.createServer"],"mappings":"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"}